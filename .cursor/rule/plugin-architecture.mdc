# Plugin Architecture

## ğŸ—ï¸ í”ŒëŸ¬ê·¸ì¸ ì‹œìŠ¤í…œ ê°œìš”

Loro Editì˜ í”ŒëŸ¬ê·¸ì¸ ì•„í‚¤í…ì²˜ëŠ” í™•ì¥ ê°€ëŠ¥í•˜ê³  ëª¨ë“ˆí™”ëœ HTML ìš”ì†Œ ì²˜ë¦¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

## ğŸ”§ Plugin Interface

### ê¸°ë³¸ êµ¬ì¡°
```typescript
interface Plugin {
  name: string;
  version: string;
  description: string;
  selectable?: SelectableConfig;
  match: (element: Element) => boolean;
  parse: (element: Element) => ParsedElement | null;
  render: (context: PluginRenderContext) => React.ReactNode;
}
```

### SelectableConfig
```typescript
interface SelectableConfig {
  enabled: boolean;
  name: string;
  color: string;
  description?: string;
  level: "element" | "component";
  elementType?: "block" | "inline";
}
```

## ğŸ“¦ ë“±ë¡ëœ í”ŒëŸ¬ê·¸ì¸ë“¤

### 1. Text Plugin
```typescript
export const textPlugin: Plugin = {
  name: "text",
  selectable: {
    enabled: true,
    name: "Text",
    color: "#10b981", // green
    elementType: "inline",
  },
  match: (element) => element.getAttribute("data-element-type") === "text",
  parse: (element) => ({ type: "text", content: element.textContent }),
  render: ({ parsedElement }) => <EditableText {...parsedElement} />
};
```

### 2. SVG Plugin  
```typescript
export const svgPlugin: Plugin = {
  name: "svg",
  selectable: {
    enabled: true,
    name: "SVG",
    color: "#f59e0b", // amber - same as image
    elementType: "inline",
  },
  match: (element) => element.tagName.toLowerCase() === "svg",
  parse: (element) => ({ type: "svg", svgContent: element.outerHTML }),
  render: ({ parsedElement }) => <EditableSvg {...parsedElement} />
};
```

### 3. Image Plugin
```typescript
export const imagePlugin: Plugin = {
  name: "image",
  selectable: {
    enabled: true,
    name: "Image",
    color: "#f59e0b", // amber
    elementType: "inline",
  },
  match: (element) => ["img", "picture"].includes(element.tagName.toLowerCase()),
  // ...
};
```

### 4. Section Plugin
```typescript
export const sectionPlugin: Plugin = {
  name: "section",
  selectable: {
    enabled: true,
    name: "Section",
    color: "#3b82f6", // blue
    elementType: "block",
  },
  match: (element) => ["section", "header", "footer", "nav"].includes(element.tagName.toLowerCase()),
  // ...
};
```

### 5. Database Plugin
```typescript
export const databasePlugin: Plugin = {
  name: "database",
  selectable: {
    enabled: true,
    name: "Database",
    color: "#8b5cf6", // purple
    elementType: "block",
  },
  match: (element) => element.hasAttribute("data-database"),
  // ...
};
```

### 6. Repeat Container Plugin
```typescript
export const repeatContainerPlugin: Plugin = {
  name: "repeat-container",
  selectable: {
    enabled: true,
    name: "Repeat Container",
    color: "#ef4444", // red
    elementType: "block",
  },
  match: (element) => element.hasAttribute("data-repeat-container"),
  // ...
};
```

### 7. Element Plugin (Fallback)
```typescript
export const elementPlugin: Plugin = {
  name: "element",
  selectable: {
    enabled: false, // ì„ íƒ ë¶ˆê°€ëŠ¥í•œ ê¸°ë³¸ ìš”ì†Œ
    name: "Element",
    color: "#6b7280", // gray
  },
  match: (element) => true, // ëª¨ë“  ìš”ì†Œ ë§¤ì¹­ (fallback)
  // ...
};
```

## ğŸ”„ í”ŒëŸ¬ê·¸ì¸ ë¼ì´í”„ì‚¬ì´í´

### 1. ë“±ë¡ (Registration)
```typescript
// src/plugins/index.ts
export function registerDefaultPlugins() {
  if (pluginManager.plugins.length > 0) {
    console.log('Plugins already registered, skipping...');
    return;
  }

  console.log('Registering default plugins...');
  
  pluginManager.register(imagePlugin);
  pluginManager.register(svgPlugin);
  pluginManager.register(repeatContainerPlugin);
  pluginManager.register(databasePlugin);
  pluginManager.register(sectionPlugin);
  pluginManager.register(elementPlugin); // fallback
  pluginManager.register(textPlugin);
}
```

### 2. ë§¤ì¹­ (Matching)
```typescript
// PluginManager.ts
parseElement(element: Element): ParsedElement | null {
  for (const plugin of this.plugins) {
    if (plugin.match(element)) {
      console.log(`Plugin "${plugin.name}" matched element:`, element);
      return plugin.parse(element);
    }
  }
  return null;
}
```

### 3. íŒŒì‹± (Parsing)
HTML Element â†’ ParsedElement ë³€í™˜

### 4. ë Œë”ë§ (Rendering)
```typescript
renderElement(mockElement: Element, parsedElement: ParsedElement, context: PluginContext): React.ReactNode {
  for (const plugin of this.plugins) {
    if (plugin.match(mockElement)) {
      return plugin.render({
        parsedElement,
        ...context,
        renderElement: context.renderElement
      });
    }
  }
  return null;
}
```

## ğŸ¯ ì„ íƒ ì‹œìŠ¤í…œ í†µí•©

### getSelectableConfig í•¨ìˆ˜
```typescript
function getSelectableConfig(element: ParsedElement): SelectableConfig | null {
  const plugin = pluginManager.plugins.find(p => {
    switch (element.type) {
      case 'text': return p.name === 'text';
      case 'svg': return p.name === 'svg';
      case 'img': case 'picture': return p.name === 'image';
      case 'database': return p.name === 'database';
      case 'repeat-container': return p.name === 'repeat-container';
      case 'element':
        if ('tagName' in element) {
          const tagName = element.tagName;
          if (['section', 'header', 'footer', 'nav'].includes(tagName)) {
            return p.name === 'section';
          }
        }
        return p.name === 'element';
      default: return false;
    }
  });

  return plugin?.selectable?.enabled ? plugin.selectable : null;
}
```

## ğŸ”§ í”ŒëŸ¬ê·¸ì¸ ê°œë°œ ê°€ì´ë“œ

### ìƒˆ í”ŒëŸ¬ê·¸ì¸ ìƒì„±
```typescript
// src/plugins/my-plugin.tsx
export const myPlugin: Plugin = {
  name: "my-element",
  version: "1.0.0",
  description: "My custom element handler",

  selectable: {
    enabled: true,
    name: "My Element",
    color: "#06b6d4", // cyan
    elementType: "block",
  },

  match: (element: Element) => {
    return element.hasAttribute("data-my-element");
  },

  parse: (element: Element) => {
    return {
      type: "my-element" as const,
      id: element.id || crypto.randomUUID(),
      customProperty: element.getAttribute("data-custom") || "",
    };
  },

  render: ({ parsedElement, selection, setSelection }) => {
    return <MyElementComponent {...parsedElement} />;
  },
};
```

### íƒ€ì… ì •ì˜ ì¶”ê°€
```typescript
// src/types.ts
interface MyElement {
  type: "my-element";
  id: string;
  customProperty: string;
}

// ParsedElement ìœ ë‹ˆì˜¨ì— ì¶”ê°€
type ParsedElement = 
  | TextElement 
  | ImageElement 
  | SvgElement
  | MyElement  // ìƒˆ íƒ€ì… ì¶”ê°€
  | ...;
```

### í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
```typescript
// src/plugins/index.ts
import { myPlugin } from './my-plugin';

export function registerDefaultPlugins() {
  // ...
  pluginManager.register(myPlugin);
}
```

## ğŸ¨ ì„ íƒ ê¸°ë°˜ í¸ì§‘ íŒ¨í„´

### ìš”êµ¬ì‚¬í•­
> "svg ì„ íƒí•˜ë©´ ë‚˜ì˜¤ëŠ” íŒì—… í™”ë©´ì„ ê³„ì† êµ¬í˜„í•´ë´"
> "ì„ íƒê¸°ëŠ¥ë¶€í„° ì œëŒ€ë¡œ ê°œì„ í•´ë³´ì"

### êµ¬í˜„ íŒ¨í„´
1. **ì„ íƒ ê°ì§€**: í”ŒëŸ¬ê·¸ì¸ì˜ `selectable.enabled` í™•ì¸
2. **ì‹œê°ì  í”¼ë“œë°±**: ê³ ìœ  ìƒ‰ìƒìœ¼ë¡œ ì˜¤ë²„ë ˆì´ í‘œì‹œ
3. **í¸ì§‘ ë„êµ¬**: ì„ íƒëœ ìƒíƒœì—ì„œ ì»¨í…ìŠ¤íŠ¸ ë„êµ¬ ì œê³µ
4. **ì¦‰ì‹œ ì ìš©**: ë³€ê²½ì‚¬í•­ ì‹¤ì‹œê°„ ë°˜ì˜

```typescript
const EditableComponent: React.FC = ({ elementId }) => {
  const selection = useEditorStore(state => state.selection);
  const isSelected = selection.selectedElementId === elementId;

  return (
    <div data-block-element-id={elementId}>
      {/* ì»¨í…ì¸  ë Œë”ë§ */}
      
      {isSelected && (
        <FloatingToolbar onEdit={() => setOpen(true)} />
      )}
    </div>
  );
};
```

## ğŸš€ ì„±ëŠ¥ ìµœì í™”

### í”ŒëŸ¬ê·¸ì¸ ë§¤ì¹­ ìµœì í™”
```typescript
// ë¹ ë¥¸ ë§¤ì¹­ì„ ìœ„í•œ ìš°ì„ ìˆœìœ„
const MATCH_PRIORITY = [
  'text',           // ê°€ì¥ ë¹ˆë²ˆ
  'image',          // ìì£¼ ì‚¬ìš©
  'svg',            // ìƒˆë¡œ ì¶”ê°€
  'section',        // êµ¬ì¡° ìš”ì†Œ
  'database',       // íŠ¹ìˆ˜ ê¸°ëŠ¥
  'repeat-container', // ë³µì¡í•œ ë¡œì§
  'element'         // fallback (í•­ìƒ ë§ˆì§€ë§‰)
];
```

### ë©”ëª¨ì´ì œì´ì…˜
```typescript
// ì„ íƒ ê°€ëŠ¥í•œ ìš”ì†Œ íŠ¸ë¦¬ ìºì‹±
const selectableTree = useMemo(() => {
  return buildSelectableTree(parsedElements);
}, [parsedElements]);
```

### ì¡°ê±´ë¶€ ë Œë”ë§
```typescript
// ì„ íƒëœ ìƒíƒœì—ì„œë§Œ í¸ì§‘ ë„êµ¬ ë Œë”ë§
{isSelected && <EditingTools />}
```

## ğŸ”® í™•ì¥ ê³„íš

### í”ŒëŸ¬ê·¸ì¸ ì‹œìŠ¤í…œ ê°œì„ 
- [ ] í”ŒëŸ¬ê·¸ì¸ ì˜ì¡´ì„± ê´€ë¦¬
- [ ] ëŸ°íƒ€ì„ í”ŒëŸ¬ê·¸ì¸ ë¡œë”©
- [ ] í”ŒëŸ¬ê·¸ì¸ ì„¤ì • ì¸í„°í˜ì´ìŠ¤

### ìƒˆ í”ŒëŸ¬ê·¸ì¸ í›„ë³´
- [ ] Video Plugin
- [ ] Table Plugin  
- [ ] Form Plugin
- [ ] Chart Plugin

### ê³ ê¸‰ ê¸°ëŠ¥
- [ ] í”ŒëŸ¬ê·¸ì¸ ê°„ í†µì‹ 
- [ ] ì»¤ìŠ¤í…€ í›… ì§€ì›
- [ ] í”ŒëŸ¬ê·¸ì¸ ë§ˆì¼“í”Œë ˆì´ìŠ¤